{{ block title }}
{{ endblock }}
{{ block appstyles }}
<style>
.otree-timer {
    background: none !important;
    border: none !important;
}
</style>
{{ endblock }}
{{ block content }}

    <script src="{{ static 'e2mupay/openpgp.min.js' }}"></script>
    <script src="{{ static 'e2mupay/key.js' }}"></script>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h4>You have earned <b>${{ player.amount | to2 }}</b></h4>
            </div>
            <div class="card-body">
                <div class="alert alert-danger mb-4 text-center">
                    <p>Please take a screenshot or note the following payment code until you have received your payment:</p>
                    <p class="display-4 font-monospace fw-bold">{{ code_display }}</p>
                    <p class="fw-bold mb-0">You should quote this payment code whenever contacting EÂ²MU about your payment.</p>
                </div>

                <p class="fst-italic my-5">
                    This page securely collects your contact information and encrypts it before it is sent to the server. Your data will only be used by authorised officials for lawful purposes and kept within the state of Victoria. Your contact data will not be linked to your behaviour in this experiment, unless that is in your interest.
                </p>

                <p class="fst-italic my-5">
                    These data will be used to invite you to submit your payment data through an official University system. Please ensure your contact data are fully correct.
                    <b>Please, if possible, provide an official institutional email address, such as a University email address.</b>
                </p>

                <!-- Personal Information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="fname" class="form-label">First name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fname" name="fname" required>
                            <div class="invalid-feedback">
                                Please provide a valid first name.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="lname" class="form-label">Last name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="lname" name="lname" required>
                            <div class="invalid-feedback">
                                Please provide a valid last name.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="email" class="form-label">Institutional email address <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="email" name="email" required>
                    <div class="invalid-feedback">
                        Please provide a valid email address.
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-lg" id="submitButton">Submit</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Review Contact Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Please review your contact information:</p>
                    <div class="border p-3 bg-light">
                        <pre id="dataPreview" style="white-space: pre-wrap; margin: 0;"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmSend">Send</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="pay_to" id="payTo" value="INVALID">

    <script>
        const amount = "{{ player.amount }}";
        const paymentCode = "{{ player.code }}";
        const participantCode = "{{ player.participant.code }}";
        const sessionCode = "{{ player.session.code }}";
        const submitButton = document.getElementById('submitButton');
        const dataPreview = document.getElementById('dataPreview');
        const confirmSendButton = document.getElementById('confirmSend');
        const hiddenField = document.getElementById('payTo');

        function totalContactData() {
            const fname = document.getElementById('fname').value.trim();
            const lname = document.getElementById('lname').value.trim();
            const email = document.getElementById('email').value.trim();

            const name = `${lname.toLocaleUpperCase()}, ${fname}`;

            if (!fname || !lname || !email) {
                return "";
            }

            return `${name}\n${email}`;
        }


        confirmSendButton.addEventListener('click', async function() {
            try {
                confirmSendButton.disabled = true;
                confirmSendButton.textContent = 'Sending...';

                const contactData = `${totalContactData()}\n\nAdditional metadata (NOT AUTHORITATIVE): ${sessionCode}, ${participantCode}, ${paymentCode}, ${amount}\n`;

                const publicKey = await openpgp.readKey({ armoredKey: pubkey });

                const encrypted = await openpgp.encrypt({
                    message: await openpgp.createMessage({ text: contactData }),
                    encryptionKeys: publicKey,
                });

                hiddenField.value = encrypted.replaceAll("\r", "").replaceAll("\n", "|");

                document.querySelector('form').submit();

            } catch (error) {
                console.error('Failed to process:', error);
                confirmSendButton.disabled = false;
                confirmSendButton.textContent = 'Send';
            }
        });

        // Form validation
        function validateForm() {
            let isValid = true;

            // Reset all validation states
            document.querySelectorAll('.form-control').forEach(field => {
                field.classList.remove('is-invalid', 'is-valid');
            });

            // Validate required fields
            const fname = document.getElementById('fname');
            const lname = document.getElementById('lname');
            const email = document.getElementById('email');

            if (!fname.value.trim()) {
                fname.classList.add('is-invalid');
                isValid = false;
            } else {
                fname.classList.add('is-valid');
            }

            if (!lname.value.trim()) {
                lname.classList.add('is-invalid');
                isValid = false;
            } else {
                lname.classList.add('is-valid');
            }

            if (!email.value.trim() || !email.checkValidity()) {
                email.classList.add('is-invalid');
                isValid = false;
            } else {
                email.classList.add('is-valid');
            }

            return isValid;
        }

        // Override submit button to include validation
        submitButton.addEventListener('click', function(e) {
            e.preventDefault();

            if (!validateForm()) {
                // Scroll to first invalid field
                const firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
                return;
            }

            const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            const contactData = totalContactData();

            if (!contactData) {
                return;
            }

            dataPreview.textContent = contactData;
            confirmationModal.show();
        });
    </script>

    {{ endblock }}
